--- { "kind": "pipeline", "name": "lightning-node-pipeline", "steps": [ { "commands": [ "apk update -v", "apk upgrade -v", "apk add -v git bash make build-base ncurses", "echo -e \"machine gitlab.com\nlogin $${GITLAB_USERNAME}\npassword $${GITLAB_ACCESS_TOKEN}\" > ~/.netrc", "chmod 640 ~/.netrc", "echo -e \"machine gitlab.com\nlogin $${GITLAB_USERNAME}\npassword $${GITLAB_ACCESS_TOKEN}\" > build/docker/.netrc", "chmod 640 build/docker/.netrc", "go env -w GONOSUMDB=gitlab.com/pietroski-software-company", "go env -w GONOPROXY=gitlab.com/pietroski-software-company", "go env -w GOPRIVATE=gitlab.com/pietroski-software-company", "git config --global user.email \"pietroskisoftwarecompany@gmail.com\"", "git config --global user.name \"ptk.swe\"", "make -C .pipelines/.drone validate-gitlab-credentials" ], "environment": { "GITLAB_ACCESS_TOKEN": { "from_secret": "GITLAB_ACCESS_TOKEN" }, "GITLAB_USERNAME": { "from_secret": "GITLAB_USERNAME" } }, "image": "pietroski/alpine-docker-golang:v0.0.8", "name": "gitlab-validation-non-master", "when": { "branch": { "exclude": [ "main" ] }, "event": [ "push" ] } }, { "commands": [ "apk update -v", "apk upgrade -v", "apk add -v git bash make build-base ncurses", "echo -e \"machine gitlab.com\nlogin $${GITLAB_USERNAME}\npassword $${GITLAB_ACCESS_TOKEN}\" > ~/.netrc", "chmod 640 ~/.netrc", "echo -e \"machine gitlab.com\nlogin $${GITLAB_USERNAME}\npassword $${GITLAB_ACCESS_TOKEN}\" > build/docker/.netrc", "chmod 640 build/docker/.netrc", "go env -w GONOSUMDB=gitlab.com/pietroski-software-company", "go env -w GONOPROXY=gitlab.com/pietroski-software-company", "go env -w GOPRIVATE=gitlab.com/pietroski-software-company", "git config --global user.email \"pietroskisoftwarecompany@gmail.com\"", "git config --global user.name \"ptk.swe\"", "make -C .pipelines/.drone validate-docker-in-docker" ], "depends_on": [ "gitlab-validation-non-master" ], "environment": { "GITLAB_ACCESS_TOKEN": { "from_secret": "GITLAB_ACCESS_TOKEN" }, "GITLAB_USERNAME": { "from_secret": "GITLAB_USERNAME" } }, "image": "pietroski/alpine-docker-golang:v0.0.8", "name": "docker-validation-non-master", "privileged": true, "volumes": [ { "name": "dockersock", "path": "/var/run/docker.sock" } ], "when": { "branch": { "exclude": [ "main" ] }, "event": [ "push" ] } }, { "commands": [ "apk update -v", "apk upgrade -v", "apk add -v git bash make build-base ncurses", "echo -e \"machine gitlab.com\nlogin $${GITLAB_USERNAME}\npassword $${GITLAB_ACCESS_TOKEN}\" > ~/.netrc", "chmod 640 ~/.netrc", "echo -e \"machine gitlab.com\nlogin $${GITLAB_USERNAME}\npassword $${GITLAB_ACCESS_TOKEN}\" > build/docker/.netrc", "chmod 640 build/docker/.netrc", "go env -w GONOSUMDB=gitlab.com/pietroski-software-company", "go env -w GONOPROXY=gitlab.com/pietroski-software-company", "go env -w GOPRIVATE=gitlab.com/pietroski-software-company", "git config --global user.email \"pietroskisoftwarecompany@gmail.com\"", "git config --global user.name \"ptk.swe\"", "make unit-tests" ], "environment": { "GITLAB_ACCESS_TOKEN": { "from_secret": "GITLAB_ACCESS_TOKEN" }, "GITLAB_USERNAME": { "from_secret": "GITLAB_USERNAME" } }, "image": "pietroski/alpine-docker-golang:v0.0.8", "name": "unit-tests-suite-non-master", "when": { "branch": { "exclude": [ "main" ] }, "event": [ "push" ] } }, { "commands": [ "apk update -v", "apk upgrade -v", "apk add -v git bash make build-base ncurses", "echo -e \"machine gitlab.com\nlogin $${GITLAB_USERNAME}\npassword $${GITLAB_ACCESS_TOKEN}\" > ~/.netrc", "chmod 640 ~/.netrc", "echo -e \"machine gitlab.com\nlogin $${GITLAB_USERNAME}\npassword $${GITLAB_ACCESS_TOKEN}\" > build/docker/.netrc", "chmod 640 build/docker/.netrc", "go env -w GONOSUMDB=gitlab.com/pietroski-software-company", "go env -w GONOPROXY=gitlab.com/pietroski-software-company", "go env -w GOPRIVATE=gitlab.com/pietroski-software-company", "git config --global user.email \"pietroskisoftwarecompany@gmail.com\"", "git config --global user.name \"ptk.swe\"", "make integration-tests" ], "depends_on": [ "docker-validation-non-master" ], "environment": { "GITLAB_ACCESS_TOKEN": { "from_secret": "GITLAB_ACCESS_TOKEN" }, "GITLAB_USERNAME": { "from_secret": "GITLAB_USERNAME" } }, "image": "pietroski/alpine-docker-golang:v0.0.8", "name": "integration-tests-suite-non-master", "network_mode": "host", "privileged": true, "volumes": [ { "name": "dockersock", "path": "/var/run/docker.sock" } ], "when": { "branch": { "exclude": [ "main" ] }, "event": [ "push" ] } }, { "commands": [ "apk update -v", "apk upgrade -v", "apk add -v git bash make build-base ncurses", "echo -e \"machine gitlab.com\nlogin $${GITLAB_USERNAME}\npassword $${GITLAB_ACCESS_TOKEN}\" > ~/.netrc", "chmod 640 ~/.netrc", "echo -e \"machine gitlab.com\nlogin $${GITLAB_USERNAME}\npassword $${GITLAB_ACCESS_TOKEN}\" > build/docker/.netrc", "chmod 640 build/docker/.netrc", "go env -w GONOSUMDB=gitlab.com/pietroski-software-company", "go env -w GONOPROXY=gitlab.com/pietroski-software-company", "go env -w GOPRIVATE=gitlab.com/pietroski-software-company", "git config --global user.email \"pietroskisoftwarecompany@gmail.com\"", "git config --global user.name \"ptk.swe\"", "make -C .pipelines/.drone validate-gitlab-credentials" ], "environment": { "GITLAB_ACCESS_TOKEN": { "from_secret": "GITLAB_ACCESS_TOKEN" }, "GITLAB_USERNAME": { "from_secret": "GITLAB_USERNAME" } }, "image": "pietroski/alpine-docker-golang:v0.0.8", "name": "gitlab-validation-master", "when": { "branch": [ "main" ], "event": [ "push" ] } }, { "commands": [ "apk update -v", "apk upgrade -v", "apk add -v git bash make build-base ncurses", "echo -e \"machine gitlab.com\nlogin $${GITLAB_USERNAME}\npassword $${GITLAB_ACCESS_TOKEN}\" > ~/.netrc", "chmod 640 ~/.netrc", "echo -e \"machine gitlab.com\nlogin $${GITLAB_USERNAME}\npassword $${GITLAB_ACCESS_TOKEN}\" > build/docker/.netrc", "chmod 640 build/docker/.netrc", "go env -w GONOSUMDB=gitlab.com/pietroski-software-company", "go env -w GONOPROXY=gitlab.com/pietroski-software-company", "go env -w GOPRIVATE=gitlab.com/pietroski-software-company", "git config --global user.email \"pietroskisoftwarecompany@gmail.com\"", "git config --global user.name \"ptk.swe\"", "make -C .pipelines/.drone validate-docker-in-docker" ], "depends_on": [ "gitlab-validation-master" ], "environment": { "GITLAB_ACCESS_TOKEN": { "from_secret": "GITLAB_ACCESS_TOKEN" }, "GITLAB_USERNAME": { "from_secret": "GITLAB_USERNAME" } }, "image": "pietroski/alpine-docker-golang:v0.0.8", "name": "docker-validation-master", "privileged": true, "volumes": [ { "name": "dockersock", "path": "/var/run/docker.sock" } ], "when": { "branch": [ "main" ], "event": [ "push" ] } }, { "commands": [ "apk update -v", "apk upgrade -v", "apk add -v git bash make build-base ncurses", "echo -e \"machine gitlab.com\nlogin $${GITLAB_USERNAME}\npassword $${GITLAB_ACCESS_TOKEN}\" > ~/.netrc", "chmod 640 ~/.netrc", "echo -e \"machine gitlab.com\nlogin $${GITLAB_USERNAME}\npassword $${GITLAB_ACCESS_TOKEN}\" > build/docker/.netrc", "chmod 640 build/docker/.netrc", "go env -w GONOSUMDB=gitlab.com/pietroski-software-company", "go env -w GONOPROXY=gitlab.com/pietroski-software-company", "go env -w GOPRIVATE=gitlab.com/pietroski-software-company", "git config --global user.email \"pietroskisoftwarecompany@gmail.com\"", "git config --global user.name \"ptk.swe\"", "make unit-tests" ], "environment": { "GITLAB_ACCESS_TOKEN": { "from_secret": "GITLAB_ACCESS_TOKEN" }, "GITLAB_USERNAME": { "from_secret": "GITLAB_USERNAME" } }, "image": "pietroski/alpine-docker-golang:v0.0.8", "name": "unit-tests-suite-master", "when": { "branch": [ "main" ], "event": [ "push" ] } }, { "commands": [ "apk update -v", "apk upgrade -v", "apk add -v git bash make build-base ncurses", "echo -e \"machine gitlab.com\nlogin $${GITLAB_USERNAME}\npassword $${GITLAB_ACCESS_TOKEN}\" > ~/.netrc", "chmod 640 ~/.netrc", "echo -e \"machine gitlab.com\nlogin $${GITLAB_USERNAME}\npassword $${GITLAB_ACCESS_TOKEN}\" > build/docker/.netrc", "chmod 640 build/docker/.netrc", "go env -w GONOSUMDB=gitlab.com/pietroski-software-company", "go env -w GONOPROXY=gitlab.com/pietroski-software-company", "go env -w GOPRIVATE=gitlab.com/pietroski-software-company", "git config --global user.email \"pietroskisoftwarecompany@gmail.com\"", "git config --global user.name \"ptk.swe\"", "make integration-tests" ], "depends_on": [ "docker-validation-master" ], "environment": { "GITLAB_ACCESS_TOKEN": { "from_secret": "GITLAB_ACCESS_TOKEN" }, "GITLAB_USERNAME": { "from_secret": "GITLAB_USERNAME" } }, "image": "pietroski/alpine-docker-golang:v0.0.8", "name": "integration-tests-suite-master", "network_mode": "host", "privileged": true, "volumes": [ { "name": "dockersock", "path": "/var/run/docker.sock" } ], "when": { "branch": [ "main" ], "event": [ "push" ] } }, { "commands": [ "apk update -v", "apk upgrade -v", "apk add -v git bash make build-base ncurses", "echo -e \"machine gitlab.com\nlogin $${GITLAB_USERNAME}\npassword $${GITLAB_ACCESS_TOKEN}\" > ~/.netrc", "chmod 640 ~/.netrc", "echo -e \"machine gitlab.com\nlogin $${GITLAB_USERNAME}\npassword $${GITLAB_ACCESS_TOKEN}\" > build/docker/.netrc", "chmod 640 build/docker/.netrc", "git checkout -b release/merging-branch", "git remote add gitlab https://gitlab.com/pietroski-software-company/lightning-db.git", "git push gitlab release/merging-branch -f" ], "depends_on": [ "unit-tests-suite-master", "integration-tests-suite-master" ], "environment": { "GITLAB_ACCESS_TOKEN": { "from_secret": "GITLAB_ACCESS_TOKEN" }, "GITLAB_USERNAME": { "from_secret": "GITLAB_USERNAME" } }, "image": "pietroski/alpine-docker-golang:v0.0.8", "name": "gitlab-push", "when": { "branch": [ "main" ], "event": [ "push" ] } }, { "commands": [ "apk update -v", "apk upgrade -v", "apk add -v git bash make build-base ncurses", "echo -e \"machine gitlab.com\nlogin $${GITLAB_USERNAME}\npassword $${GITLAB_ACCESS_TOKEN}\" > ~/.netrc", "chmod 640 ~/.netrc", "echo -e \"machine gitlab.com\nlogin $${GITLAB_USERNAME}\npassword $${GITLAB_ACCESS_TOKEN}\" > build/docker/.netrc", "chmod 640 build/docker/.netrc", "go env -w GONOSUMDB=gitlab.com/pietroski-software-company", "go env -w GONOPROXY=gitlab.com/pietroski-software-company", "go env -w GOPRIVATE=gitlab.com/pietroski-software-company", "git config --global user.email \"pietroskisoftwarecompany@gmail.com\"", "git config --global user.name \"ptk.swe\"", "make -C .pipelines/.drone validate-gitlab-credentials" ], "environment": { "GITLAB_ACCESS_TOKEN": { "from_secret": "GITLAB_ACCESS_TOKEN" }, "GITLAB_USERNAME": { "from_secret": "GITLAB_USERNAME" } }, "image": "pietroski/alpine-docker-golang:v0.0.8", "name": "gitlab-validation-tagging", "when": { "branch": [ "*" ], "event": [ "tag" ] } }, { "commands": [ "apk update -v", "apk upgrade -v", "apk add -v git bash make build-base ncurses", "echo -e \"machine gitlab.com\nlogin $${GITLAB_USERNAME}\npassword $${GITLAB_ACCESS_TOKEN}\" > ~/.netrc", "chmod 640 ~/.netrc", "echo -e \"machine gitlab.com\nlogin $${GITLAB_USERNAME}\npassword $${GITLAB_ACCESS_TOKEN}\" > build/docker/.netrc", "chmod 640 build/docker/.netrc", "go env -w GONOSUMDB=gitlab.com/pietroski-software-company", "go env -w GONOPROXY=gitlab.com/pietroski-software-company", "go env -w GOPRIVATE=gitlab.com/pietroski-software-company", "git config --global user.email \"pietroskisoftwarecompany@gmail.com\"", "git config --global user.name \"ptk.swe\"", "make -C .pipelines/.drone validate-docker-in-docker" ], "depends_on": [ "gitlab-validation-tagging" ], "environment": { "GITLAB_ACCESS_TOKEN": { "from_secret": "GITLAB_ACCESS_TOKEN" }, "GITLAB_USERNAME": { "from_secret": "GITLAB_USERNAME" } }, "image": "pietroski/alpine-docker-golang:v0.0.8", "name": "docker-validation-tagging", "privileged": true, "volumes": [ { "name": "dockersock", "path": "/var/run/docker.sock" } ], "when": { "branch": [ "*" ], "event": [ "tag" ] } }, { "commands": [ "apk update -v", "apk upgrade -v", "apk add -v git bash make build-base ncurses", "echo -e \"machine gitlab.com\nlogin $${GITLAB_USERNAME}\npassword $${GITLAB_ACCESS_TOKEN}\" > ~/.netrc", "chmod 640 ~/.netrc", "echo -e \"machine gitlab.com\nlogin $${GITLAB_USERNAME}\npassword $${GITLAB_ACCESS_TOKEN}\" > build/docker/.netrc", "chmod 640 build/docker/.netrc", "go env -w GONOSUMDB=gitlab.com/pietroski-software-company", "go env -w GONOPROXY=gitlab.com/pietroski-software-company", "go env -w GOPRIVATE=gitlab.com/pietroski-software-company", "git config --global user.email \"pietroskisoftwarecompany@gmail.com\"", "git config --global user.name \"ptk.swe\"", "make unit-tests" ], "environment": { "GITLAB_ACCESS_TOKEN": { "from_secret": "GITLAB_ACCESS_TOKEN" }, "GITLAB_USERNAME": { "from_secret": "GITLAB_USERNAME" } }, "image": "pietroski/alpine-docker-golang:v0.0.8", "name": "unit-tests-suite-tagging", "when": { "branch": [ "*" ], "event": [ "tag" ] } }, { "commands": [ "apk update -v", "apk upgrade -v", "apk add -v git bash make build-base ncurses", "echo -e \"machine gitlab.com\nlogin $${GITLAB_USERNAME}\npassword $${GITLAB_ACCESS_TOKEN}\" > ~/.netrc", "chmod 640 ~/.netrc", "echo -e \"machine gitlab.com\nlogin $${GITLAB_USERNAME}\npassword $${GITLAB_ACCESS_TOKEN}\" > build/docker/.netrc", "chmod 640 build/docker/.netrc", "go env -w GONOSUMDB=gitlab.com/pietroski-software-company", "go env -w GONOPROXY=gitlab.com/pietroski-software-company", "go env -w GOPRIVATE=gitlab.com/pietroski-software-company", "git config --global user.email \"pietroskisoftwarecompany@gmail.com\"", "git config --global user.name \"ptk.swe\"", "make integration-tests" ], "depends_on": [ "docker-validation-tagging" ], "environment": { "GITLAB_ACCESS_TOKEN": { "from_secret": "GITLAB_ACCESS_TOKEN" }, "GITLAB_USERNAME": { "from_secret": "GITLAB_USERNAME" } }, "image": "pietroski/alpine-docker-golang:v0.0.8", "name": "integration-tests-suite-tagging", "network_mode": "host", "privileged": true, "volumes": [ { "name": "dockersock", "path": "/var/run/docker.sock" } ], "when": { "branch": [ "*" ], "event": [ "tag" ] } }, { "commands": [ "apk update -v", "apk upgrade -v", "apk add -v git bash make build-base ncurses", "echo -e \"machine gitlab.com\nlogin $${GITLAB_USERNAME}\npassword $${GITLAB_ACCESS_TOKEN}\" > ~/.netrc", "chmod 640 ~/.netrc", "echo -e \"machine gitlab.com\nlogin $${GITLAB_USERNAME}\npassword $${GITLAB_ACCESS_TOKEN}\" > build/docker/.netrc", "chmod 640 build/docker/.netrc", "git remote add gitlab https://gitlab.com/pietroski-software-company/lightning-db.git", "make tag", "git push gitlab --tags" ], "depends_on": [ "unit-tests-suite-tagging", "integration-tests-suite-tagging" ], "environment": { "GITLAB_ACCESS_TOKEN": { "from_secret": "GITLAB_ACCESS_TOKEN" }, "GITLAB_USERNAME": { "from_secret": "GITLAB_USERNAME" } }, "image": "pietroski/alpine-docker-golang:v0.0.8", "name": "gitlab-tag", "when": { "branch": [ "*" ], "event": [ "tag" ] } } ], "volumes": [ { "host": { "path": "/var/run/docker.sock" }, "name": "dockersock", "tmp": { } } ] }
